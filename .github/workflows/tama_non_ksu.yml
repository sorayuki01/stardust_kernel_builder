name: TAMA NON-KSU

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        codename:
          - akari
          - akatsuki
          - apollo
          - aurora
          - akari_kddi
          - akatsuki_kddi
          - apollo_dcm
          - aurora_kddi

    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
      KERNEL_VER: Stardust-v1.7
      KERNEL_BRANCH: master
      KERNEL_VARIANT: NON-KSU
      KERNEL_REPO: https://github.com/Sorayukii/stardust_kernel_sony_sdm845
      ANYKERNEL_REPO: https://github.com/Sorayukii/AnyKernel3
      CLANG_URL: https://gitlab.com/kei-space/clang/r536225.git

    steps:
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison ca-certificates curl flex gcc git libc6-dev libssl-dev \
          openssl python-is-python3 ssh wget zip sudo make clang \
          gcc-arm-linux-gnueabi software-properties-common build-essential \
          libarchive-tools gcc-aarch64-linux-gnu libssl-dev libffi-dev \
          libncurses5-dev zlib1g zlib1g-dev libreadline-dev libbz2-dev \
          libsqlite3-dev make gcc pigz python3 cpio lld

    - name: Clone kernel source
      run: |
        git clone --depth=1 "$KERNEL_REPO" -b "$KERNEL_BRANCH" kernel
        cd kernel
        echo "KERNEL_DIR=$(pwd)" >> $GITHUB_ENV

    - name: Clone AnyKernel3
      run: |
        cd $KERNEL_DIR
        git clone --depth=1 -b "${{ matrix.codename }}" "$ANYKERNEL_REPO" AnyKernel3
        echo "ANYKERNEL_DIR=$KERNEL_DIR/AnyKernel3" >> $GITHUB_ENV

    - name: Clone clang
      run: |
        cd $KERNEL_DIR
        git clone --depth=1 "$CLANG_URL" clang
        echo "CLANG_DIR=$KERNEL_DIR/clang" >> $GITHUB_ENV

    - name: Generate defconfig
      run: |
        cd $KERNEL_DIR
        CONFIG_NAME="tama_${{ matrix.codename }}_defconfig"
        DEFCONFIG_PATH="arch/arm64/configs/$CONFIG_NAME"
        sed -i "s/CONFIG_LOCALVERSION=\"-perf\"/CONFIG_LOCALVERSION=\"-$KERNEL_VER\"/" "$DEFCONFIG_PATH"
        make O=out ARCH=arm64 "$CONFIG_NAME"
        mv out/.config "$DEFCONFIG_PATH"

    - name: Build kernel
      run: |
        escape_markdown_v2() { 
            echo "$1" | sed -e 's/\\/\\\\/g' -e 's/_/\\_/g' -e 's/\*/\\*/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\\~/g' -e 's/`/\\`/g' -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/|/\\|/g' -e 's/{/\\{/g' -e 's/}/\\}/g';
        }

        send_telegram_message() {
            local MESSAGE="$1"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d "chat_id=$CHAT_ID" \
                -d "text=$MESSAGE"
        }

        send_telegram_file() {
            local FILE_PATH="$1"
            local FILE_NAME=$(basename "$FILE_PATH")
            local ESCAPED_NAME=$(escape_markdown_v2 "$FILE_NAME")
            local CAPTION="\`$ESCAPED_NAME\`"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
                -F "chat_id=$CHAT_ID" \
                -F "document=@$FILE_PATH" \
                -F "caption=$CAPTION" \
                -F "parse_mode=MarkdownV2"
        }

        stop_handler() {
          send_telegram_message "âš ï¸ Compilation for ${{ matrix.codename }} was unexpectedly stopped!"
          [ -f "$LOG_FILE" ] && send_telegram_file "$LOG_FILE"
          exit 1
        }

        trap stop_handler ERR INT

        cd $KERNEL_DIR
        LOG_FILE=$KERNEL_DIR/build.log
        OUT_DIR=$KERNEL_DIR/out
        KERNEL_IMAGE_DIR=$OUT_DIR/arch/arm64/boot
        KERNEL_IMAGE=$KERNEL_IMAGE_DIR/Image.gz-dtb
        CONFIG_NAME="tama_${{ matrix.codename }}_defconfig"
        KERNEL_COMMIT_ID=$(git rev-parse --short=7 HEAD)
        ZIP_NAME="${KERNEL_VER}_${{ matrix.codename }}-${KERNEL_VARIANT}-${KERNEL_COMMIT_ID}-$(date +%Y%m%d).zip"
        echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "KERNEL_COMMIT_ID=$KERNEL_COMMIT_ID" >> $GITHUB_ENV
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV

        send_telegram_message "ðŸ”¨ Starting kernel compilation for ${{ matrix.codename }} on branch $KERNEL_BRANCH!"

        export KBUILD_BUILD_USER=ivy
        export KBUILD_BUILD_HOST="$KERNEL_COMMIT_ID"
        export PATH="$CLANG_DIR/bin:$PATH"

        mkdir -p "$OUT_DIR"

        make O="$OUT_DIR" ARCH=arm64 "$CONFIG_NAME"
        make -j$(nproc) O="$OUT_DIR" ARCH=arm64 \
          CC=clang LD=ld.lld AR=llvm-ar AS=llvm-as NM=llvm-nm \
          OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip \
          CROSS_COMPILE=aarch64-linux-gnu- CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          2>&1 | tee -a "$LOG_FILE"

        BUILD_RESULT=${PIPESTATUS[0]}

        if [ "$BUILD_RESULT" -ne 0 ]; then
          send_telegram_message "âŒ Compilation failed for ${{ matrix.codename }}!"
          send_telegram_file "$LOG_FILE"
          exit 1
        fi

        cp "$KERNEL_IMAGE" "$ANYKERNEL_DIR/Image.gz-dtb"
        cd "$ANYKERNEL_DIR"
        zip -r9 "../$ZIP_NAME" ./* > /dev/null
        cd "$KERNEL_DIR"

        send_telegram_file "$ZIP_NAME"
        send_telegram_file "$LOG_FILE"
        send_telegram_message "âœ… Compilation completed for ${{ matrix.codename }} Flashable zip is ready."

    - name: Upload kernel to GitHub Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.KERNEL_VER }}_${{ env.KERNEL_VARIANT }}
        name: ${{ env.KERNEL_VER }} ${{ env.KERNEL_VARIANT }}
        body: |
          **Target Platform**
          - Device Family     : Sony Tama
          - SoC               : Qualcomm Snapdragon 845
          - Architecture      : ARM64
          - Android Version   : A12â€“A15
          
          **Build Information**
          - Kernel Version    : ${{ env.KERNEL_VER }}
          - Variant           : ${{ env.KERNEL_VARIANT }}
          - Build Date        : ${{ env.BUILD_DATE }}
          - Compiler          : AOSP Clang

          **Flash Instructions**
          1. Flash via TWRP / OrangeFox
          3. Reboot system

          **Notes**
          - This release contains NON-KSU builds only
          - You can use Apatch or Magisk for getting root acces
          - Each device codename has its own flashable zip

        files: |
          ${{ env.KERNEL_DIR }}/${{ env.ZIP_NAME }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        
